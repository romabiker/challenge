# Backend test task

### Ожидаемое время выполнения: 3-5 часов

Ниже приведено краткое описание проблемы, а также несколько базовых ограничений и требований. Задача оценивает ваше умение реализовать решение, используя наш технологический стек, и мы ожидаем поддерживаемый, хорошо документированный код, соответствующий лучшим практикам.

### Ожидаемые результаты
- **Репозиторий**: Сделайте копию предоставленного репозитория-шаблона и отправьте свою работу через pull request в вашем репозитории, используя [эту форму Typeform](https://hiretechfast.typeform.com/to/QZ55qiDi)
- **Документация**: Включите краткое руководство по настройке проекта с вашими изменениями. Добавьте документацию, которая объясняет ваше техническое решение и выбор архитектурных решений. Диаграмма архитектуры является необязательной, но рекомендуется.
- **Качество кода**: Убедитесь, что ваш код читаем, поддерживаем и форматирован последовательно.
- **Тестирование**: Реализуйте комплексные unit-тесты для всего нового кода. Используйте pytest с pytest-django для создания фикстур, если это уместно.
- **Логи и трассировка**: Реализуйте структурированное логирование с помощью `structlog` (уже включен в проект) и добавьте трассировку через Sentry transactions или аналогичный инструмент.

## Стек технологий

- **Языки и фреймворки**: Python, Django
- **Тестирование**: pytest (pytest-django предпочтительно для фикстур)
- **Инфраструктура**: Docker & docker-compose
- **База данных**: PostgreSQL
- **Фоновые задачи**: Celery & Celery Beat
- **База данных для логов**: ClickHouse (включен в Docker окружение)

## Проблема
Наше приложение отправляет event-логи, которые затем используются для бизнес-анализа, расследования инцидентов и аудита безопасности. В настоящее время логи отправляются напрямую в ClickHouse в формате "One Big Table" (OBT) с колонками:

| Колонка           | Тип       |
|-------------------|-----------|
| event_type        | String    |
| event_date_time   | DateTime  |
| environment       | String    |
| event_context     | JSON      |
| metadata_version  | UInt64    |

В текущей реализации запись происходит синхронно из кода приложения напрямую в CH, см. пример в `CreateUser` use case:

С таким подходом возникли проблемы, некоторые из которых:
- из-за отсутствия транзакционности события терялись в случае, если веб-воркер приложения умирал между завершением выполнения бизнес-логики и записью в CH
- сетевые ошибки при записи в CH приводили к ошибкам на UI, что ухудшало UX
- CH страдал от большого количества построчных записей (см. https://clickhouse.com/blog/common-getting-started-issues-with-clickhouse#many-small-inserts)

Необходимо реализовать механизм записи, который позволит избавиться от перечисленных проблем, а также упростить написание и тестирование бизнес-логики через понятный интерфейс публикации событий



## Требования
- **Выбор шаблона**: Используйте шаблон транзакционного outbox или аналогичный подход с хорошей документацией.
- **Простота решения**: Избегайте использования Kafka или файлового хранилища, как AWS S3. Используйте простое и эффективное решение, базирующееся на известных технологиях, чтобы поддерживать и мониторить его было легко.
- **Пакетирование**: Реализуйте пакетирование, чтобы минимизировать количество вставок в ClickHouse и снизить нагрузку на систему.
- **Избегайте хардкода**: Не хардкодьте значения, такие как URL-адреса; придерживайтесь принципов 12-factor app.
- **Логирование и обработка ошибок**: Интегрируйтесь с существующим структурированным логированием (structlog), чтобы избежать фрагментации.
- **Избегайте избыточных шаблонов**: Убедитесь, что любые используемые шаблоны действительно добавляют ценность. Избегайте шаблонов, которые просто оборачивают ORM, не улучшая читабельность или абстракцию.
- **Повторное использование и разделение логики**: Отделите основную логику обработки логов от задач Celery для повышения возможности повторного использования.
- **Тестирование**: По возможности тестируйте непосредственно с экземпляром ClickHouse, включенным в Docker. Избегайте использования моков, если это не необходимо.
